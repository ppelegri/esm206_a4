---
title: "Snowshoe Hares"
author: "Patrick Pelegri-O'Day"
date: "11/5/2021"
output: html_document
---

## Introduction **UPDATE**
A 4 - 5 sentence "mini-introduction" to what this study is exploring, including basic background information about the subject, site and study (with citations as needed), and a brief overview of what is included in the exploratory report. 

## Data and Analyses **UPDATE**
A 3 - 4 sentence section in which you briefly describe the data, including citation & credit as needed, and provide an overview of the main analysis, statistical methods and tools used.

**Data citation:** Kielland, K., F.S. Chapin, R.W. Ruess, and Bonanza Creek LTER. 2017. Snowshoe hare physical data in Bonanza Creek Experimental Forest: 1999-Present ver 22. Environmental Data Initiative. https://doi.org/10.6073/pasta/03dce4856d79b91557d8e6ce2cbcdc14

**Link to metadata:** https://portal.edirepository.org/nis/metadataviewer?packageid=knb-lter-bnz.55.22

## Setup

Attach packages
```{r setup, include=TRUE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(here)
library(kableExtra)
library(lubridate)
library(effsize)
library(broom)
library(ggbeeswarm)


```

Read in the data
```{r}
hares_raw <-
  read_csv(show_col_types = FALSE, here("data", "bonanza_hares.csv"))
```


## Initial data wrangling

Convert date column into YYYY-MM-DD format, change class to Date, create column year, create column grid_full with full site names, replace values in column sex with fully spelled out labels
```{r}
hares <- hares_raw %>% 
  mutate(date = mdy(date)) %>% # replace original date column with new date column in YYYY-MM-DD format in which column class is "Date"
  mutate(year = year(date)) %>% # create new column called year that contains the year, derived from the date column
  mutate(grid_full = case_when( # add a new column grid_full, which contains full site names taken from metadata
    grid %in% c("bonrip") ~ "Bonanza Riparian",
    grid %in% c("bonmat") ~ "Bonanza Mature",
    grid %in% c("bonbs") ~ "Bonanza Black Spruce")) %>% 
  mutate(sex = case_when(
    sex %in% c("m") ~ "Male",
    sex %in% c("f") ~ "Female",
    sex %in% c("NA") ~ "NA"))
```

## Visualize annual juvenile hare trap counts

Count the total number of juvenile hare trappings during each year of the study, and create a finalized data visualization of the counts by year. Include a figure caption below the figure in your report. 
```{r, fig.cap = "**Figure 1: Count of Juvenile Snowshoe Hares.** This graph displays counts of juvenile snowshe hares that were trapped in Bonanza Creek Experimental Forest. The observation period spans 1998 to 2012."}
# Group hares by year and create count per year
hares_trap_counts <- hares %>% 
  group_by(year) %>% 
  summarize(count = n())

# Visualize count of trapped hares by year
ggplot(hares_trap_counts,
       aes(x = year, y = count)) +
  geom_line() +
  geom_point() +
  labs(x = "Year", y = "Count")
```

Create table displaying maximum, minimum, and median annual counts of juvenile snowshoe hares
```{r}
# Group hares by year and calculate count per year as well as minimum count, maximum count, and median count
hares_counts_stats <- hares_trap_counts %>% 
  summarize(min_count = min(count),
            max_count = max(count),
            med_count = median(count))
  

# Create table of summary statistics
kable(hares_counts_stats, # create table
      col = c("Minimum Count", "Maximum Count", "Median Count"), # assign column names
      caption = "Table 1: Maximum, minimum, and median annual count of snowshoe hares from 1998 to 2012") %>% 
  kable_styling(full_width = FALSE) # make table narrower
```

**[INSERT 3-4 sentences describing major takeaways].** What were the minimum and maximum counts of juvenile hare trappings?
Mean or median annual number of juvenile hares trapped?
General/notable trends?
These are absolute counts, but this count is also impacted by effort (e.g. the number of days and number of traps in the study each year). What would you suggest be done moving forward (you are not expected to actually do this) to standardize the juvenile hare population in future analyses?

## Visualize juvenile hare weights

Create a finalized data visualization (or visualizations) in which you compare **juvenile hare weights by sex and site (grid)** (ignore other variables). You should include groups where these variables are not recorded (`NA`). Include finalized figure captions below your visualization(s).

Create a faceted scatter plot comparing juvenile hare weights by sex and site, including groups where these variables are not recorded (NA)
```{r, fig.cap = "**Figure 2: Juvenile hare weights by sex and site.** These three graphs display juvenile hare weights (g) by sex. The graphs are faceted by site of observation."}
ggplot(hares,
       aes(x = sex, y = weight, 
           color = grid_full)) +
  geom_jitter() +
  facet_wrap(~grid_full) +
  labs(x = "Sex", y = "Weight (g)", color = "Site")
```

Compare mean and standard deviation of hare weight by sex and site
**I'm asked to make a similar table below; should I still include this table here?**
```{r}
# Create a data frame from hares that groups by sex and site name ("grid_full") and calculates summary statistics for hare weight
hares_wt_sex_site <- hares %>% 
  group_by(sex, grid_full) %>% 
   summarize(mean = round(mean(weight, na.rm = TRUE), 1),
             sd = round(sd(weight, na.rm = TRUE), 1),
             sample_size = n())

# Create a table that displays the summary statisics calculated in the data frame above
kable(hares_wt_sex_site,
      col = c("Sex", "Site", "Mean Weight (g)", "Standard deviation", "Sample Size"),
      caption = "Table 2: Summary statistics on weight of juvenile hares by sex and site") %>% 
  kable_styling(full_width = FALSE)
```

**Then, in 2 - 3 sentences below your visualization(s) describe in text the main takeaways that you would want the audience to understand from your figures.**

- Have I updated graph labels, headers in facets, etc. to make it as straightforward as possible for viewers?
- Have I simplified and finalized my data visualization(s) to include components that are useful for the audience?

## Juvenile weight comparison for male and female snowshoe hares

Create a table of summary statistics on hare weight by sex
```{r}
# Create a data frame from hares that groups by sex and calculates summary statistics for hare weight
hares_wt_sex <- hares %>% 
  group_by(sex) %>% 
   summarize(mean = round(mean(weight, na.rm = TRUE), 1),
             sd = round(sd(weight, na.rm = TRUE), 1),
             sample_size = n())

# Create a table that displays the summary statistics calculated in the data frame above
kable(hares_wt_sex,
      col = c("Sex", "Mean Weight (g)", "Standard deviation", "Sample Size"),
      caption = "Table 3: Summary statistics on weight of juvenile hares by sex") %>% 
  kable_styling(full_width = FALSE)
```

```{r, include = FALSE}
# Data exploration to determine whether t.test is appropriate

# Pull vectors of weights for male and female juvenile snowshoe hares

f_hares <- hares %>% 
  filter(sex == "Female") %>% 
  pull(weight)

m_hares <- hares %>% 
  filter(sex == "Male") %>% 
  pull(weight)

# Plot histograms & qq-plots to check assumptions
hist(f_hares) # Looks normal
qqnorm(f_hares) # Relatively linear
hist(m_hares) # Looks pretty normal
qqnorm(m_hares) # Looks a little skewed but normal enough

# Overall: assumptions of normality hold. Because of large sample size (>1000) Central Limit Theorem holds and we expect means to be normally distributed. So, two-sample t-test is ok for means comparison.
```

Compare means: difference in means, effect size, unpaired two-sample t-test
```{r}
# create vector f_hares that contains weights only of female hares
f_hares <- hares %>% 
  filter(sex == "Female") %>% 
  pull(weight)

f_hares <- f_hares[!is.na(f_hares)] # remove NA values from f_hares

# create vector m_hares that contains weights only of male hares
m_hares <- hares %>% 
  filter(sex == "Male") %>% 
  pull(weight)

m_hares <- m_hares[!is.na(m_hares)] # remove NA values from m_hares

# run t-test
hares_t <- t.test(f_hares, m_hares)

# get tidy model results to call outputs in-line: 
hares_t_tidy <- tidy(hares_t)

# get effect size using cohen.d()
hares_cohen <- cohen.d(f_hares, m_hares)

# find means and SDs for weights of male & female hares
female_mean <- mean(f_hares)
male_mean <- mean(m_hares)
female_sd <- sd(f_hares)
male_sd <- sd(m_hares)
```

On average, juvenile female snowshoe hares are heavier than juvenile male snowshoe hares (`r round(female_mean,2)` $\pm$ `r round(female_sd, 2)` g and `r round(male_mean,2)` $\pm$ `r round(male_sd, 2)` g, respectively. The absolute difference in means is `r round(female_mean, 2) - round(male_mean, 2)` g, a difference of `r round((female_mean - male_mean)/((female_mean + male_mean)/2)*100, 2)`%. However, the difference in means is not significant (Welch's two-sample t-test: t(`r round(hares_t_tidy$parameter,2)`) = `r round(hares_t_tidy$statistic,2)`, p-value = `r hares_t_tidy$p.value`, and the effect size is negligible (Cohen's *d* = `r round(hares_cohen$estimate,2)`).

## Relationship between juvenile snowshoe hare weight and hind foot length

Visually explore relationship between hare weight and hind foot length
```{r}
ggplot(hares,
       aes(x = hindft, y = weight)) +
  geom_point() +
  labs(x = "Hind foot length (mm)", y = "Weight (g)")
```

Explore linear regression relating hare weight and hind foot length
```{r}
# run linear regression
hares_lm <- lm(weight ~ hindft, data = hares)

# get tidy versions of the model output to call later on in text
hares_lm_tidy <- tidy(hares_lm)
hares_lm_glance <- glance(hares_lm)

# visualize model diagnostics
plot(hares_lm)

# get Pearson's r correlation
hares_cor <- cor.test(hares$weight, hares$hindft)

# get tidy version of correlation output
hares_cor_tidy <- tidy(hares_cor)
```
The relationship between juvenile snowshoe hare weight and hind foot length appears somewhat linear, but with significant heteroscedasticity (Figure 3). Single variable linear regression showed that hind foot length (mm) significantly predicts juvenile hare weight (p < 0.001, R^2^ = `r round(hares_lm_glance$r.squared,2)`) with an average slope of $\beta$ = `r round(hares_lm_tidy$estimate[2], 2)` g mm^-1^ (i.e., for each one millimeter increase in hind foot length we expect an average increase in weight of `r round(hares_lm_tidy$estimate[2], 2)` g). Juvenile hare hind foot length and weight are strongly and significantly positively correlated (Pearson's *r* = `r round(hares_cor_tidy$estimate,2)`, p < 0.001). Diagnostic plots (not included) display residuals that are slightly heteroscedastic, contain outliers that may be influencing the model, and are somewhat normally distributed. 

```{r}
ggplot(data = hares, aes(x = hindft, y = weight)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal() +
  labs(x = "Hind foot length (mm)",
       y = "Weight (g)")
```
**UPDATE FOR HARES**
**Figure 3.** Relationship between flipper length (mm) and body mass (g) for the three penguin species. Points indicate individual penguin measurements (Adélie = gold circles; chinstrap = teal triangles; gentoo = coral diamonds). Linear model summary: $\beta$~1~ = `r round(penguin_lm_tidy$estimate[2], 2)` g mm^-1^, p < 0.001, R^2^ = `r round(penguin_lm_glance$r.squared,2)`, Pearson's *r* = `r round(penguin_cor_tidy$estimate,2)`). Data: Gorman et al. (2014).

## Summary **CHANGE FOR HARES**

Exploratory data analysis reveals the following initial findings: 

- Gentoo penguins are the largest of the three species in both mean flipper length and body mass
- Male gentoo penguins longer mean flipper length than female gentoos (the difference is significant, and the effect size is large)
- Flipper length appears linearly related with body mass across all three penguin species; the relationship (by simple linear regression) is significant, with a slope (expected average increase in body mass with a 1 mm increase in flipper length) of `r round(penguin_lm_tidy$estimate[2], 2)` g mm^-1^.

## Citations **CHANGE FOR HARES**

Gorman KB, Williams TD, Fraser WR (2014). Ecological sexual dimorphism and environmental variability within a community of Antarctic penguins (genus Pygoscelis). PLoS ONE 9(3):e90081. https://doi.org/10.1371/journal.pone.0090081